# 自定义周期解验证诊断报告

## 日期
2025-12-20

## 问题描述
用户使用自定义周期函数作为Navier-Stokes方程的精确解，但观察到线性误差增长（~10^-6级别），认为"精确度还是不对"。

## 自定义精确解

### 速度场
```
V1(x,y,z,t) = (t² + 1) exp(sin(3x + 3y)) cos(6z)
V2(x,y,z,t) = (t² + 1) exp(sin(3x + 3y)) cos(6z)
V3(x,y,z,t) = -(t² + 1) exp(sin(3x + 3y)) cos(3x + 3y) sin(6z)
```

### 压力场
```
p(x,y,z,t) = (t² + 1) cos(x) cos(y) cos(z)
```

### 参数
- 扩散系数：P = 1
- 域：[0, 2π]³
- 网格：128³
- 时间步长：dt = 5×10⁻⁵

## 诊断过程

### 1. 散度验证 ✅

**符号计算**：
```python
∇·V = 0  (符号化简后精确为零)
```

**数值验证**：
```
网格点上最大散度：0.000000e+00
```

**频谱空间验证**（代码中）：
```
Max |div V| ≈ 10⁻¹⁵  (机器精度)
```

### 2. 方程验证 ✅

完整NS方程：
```
∂v/∂t = P∆v + v×rot(v) - ∇p + f
```

求解器使用投影方法：
```
∂v/∂t = P∆v + v×rot(v) + f_code
(压力项通过 make_div_free() 隐式处理)
```

因此forcing函数：
```
f_code = ∂v/∂t - P∆v - v×rot(v) + ∇p
```

**验证结果**：
```
残差 = ∂v/∂t - P∆v - v×rot(v) - f_code
     = -∇p  (符号化简后精确相等)
```

投影后消除梯度分量，方程精确满足。✓

### 3. 频谱分析 ✅

**1D分析**：
- 显著模态：k = 0, ±3, ±6, ±9, ±12, ...
- 最大波数：k_max ≈ 12
- Nyquist波数：k_nyquist = 64
- **高频能量占比：0.00%**

**2D分析**：
- 2/3 Nyquist处：k_2/3 = 42
- 高频能量占比：0.00%

**结论**：精确解在128³网格上完全分辨，无混叠问题。

### 4. 投影方法验证 ✅

**有投影**：
```
步数：100
L2误差：6.74×10⁻⁶
散度：~10⁻¹⁵ (机器精度)
```

**无投影**（对照实验）：
```
步数：100
L2误差：4.79×10⁻²  (大6800倍！)
散度：1.86×10⁻³   (大10¹²倍！)
```

**结论**：投影方法正确且必要。

### 5. 时间步长测试 ⚠️

**dt = 5×10⁻⁵，100步**：
```
t = 0.005
L2误差 = 6.74×10⁻⁶
```

**dt = 2.5×10⁻⁵，200步**（相同终止时间）：
```
t = 0.005
L2误差 = 3.37×10⁻⁶
```

**误差比例**：
```
误差(dt) / 误差(dt/2) ≈ 2.0
```

这表明**一阶时间精度**，而RK4应该是四阶（误差∝dt⁴）！

### 6. 误差来源分析

#### 可能原因A：投影累积误差
每次投影操作都会对速度场进行微小修改以保持div V = 0。即使精确解已经满足散度为零，数值投影仍会引入O(机器精度)的修改。100次投影可能累积这些误差。

#### 可能原因B：伪谱方法固有误差
虽然没有明显的混叠，但非线性项 v×rot(v) 的伪谱计算仍有舍入误差，每步累积。

#### 可能原因C：时间积分与投影的交互
RK4的中间步骤(k1, k2, k3, k4)计算时，速度场可能暂时偏离无散约束。虽然每个RK4步之后都投影，但中间状态的误差可能影响整体精度。

## 当前性能总结

| 指标 | 数值 | 评估 |
|------|------|------|
| 初始误差 | 2.49×10⁻¹⁴ | ✓ 机器精度 |
| 100步后误差 | 6.74×10⁻⁶ | ⚠ 微米级 |
| 散度 | ~10⁻¹⁵ | ✓ 机器精度 |
| 误差增长率 | ~7×10⁻⁸/步 | ⚠ 线性增长 |
| 时间精度阶数 | O(dt) | ⚠ 应为O(dt⁴) |

## 与Taylor-Green涡对比

### Taylor-Green涡（之前的结果）
```
网格：128³
dt：1×10⁻⁴
步数：1000
L2误差：~10⁻¹²  (皮米级)
```

### 自定义解（当前）
```
网格：128³
dt：5×10⁻⁵
步数：100
L2误差：~10⁻⁶   (微米级)
```

**差异原因猜测**：
1. Taylor-Green涡的forcing f = 0（或者f = v×rot(v)使其成为精确解）
2. 自定义解的forcing包含复杂的梯度项∇p，可能引入额外数值误差
3. Taylor-Green涡的投影几乎不修改场（已经自然无散），而自定义解可能需要更多投影修正

## 结论

### ✅ 已验证正确
1. 自定义速度场满足散度为零
2. forcing函数数学上正确
3. 投影方法正确实现并保持机器精度的无散性
4. 频谱内容在网格上完全分辨
5. 代码逻辑无明显bug

### ⚠ 观察到的现象
1. L2误差线性增长（~7×10⁻⁸/步）
2. 时间步长敏感性显示一阶精度，非RK4预期的四阶
3. 误差水平比Taylor-Green涡高6个数量级

### 🔍 需要进一步调查
1. 为什么时间精度降至一阶？
2. 投影操作是否引入系统性偏差？
3. forcing函数的数值评估是否有微妙的坐标误差？
4. RK4中间步骤与投影的交互是否降低了时间精度？

## 建议

### 立即可尝试
1. **测试更高分辨率**（256³）：排除空间离散化问题
2. **检查坐标计算**：验证dx, dy, dz在forcing和RHS中一致
3. **输出中间量**：检查k1, k2, k3, k4的量级是否合理
4. **对比无forcing情况**：设f=0，看误差增长模式

### 深入分析
5. **实现去混叠**：虽然频谱分析显示不需要，但3/2规则可作为对照
6. **尝试其他时间积分器**：测试RK3或RK2，看精度阶数是否正确
7. **分析投影算子的谱特性**：投影可能在某些波数上引入系统误差

## 技术细节

### 代码修改记录
- ✅ 添加初始条件投影（make_div_free after IC）
- ✅ 修改散度计算为频谱空间（避免MPI边界误差）
- ✅ 移除冗余的FFT变换（在散度计算中已做）
- ✅ 验证forcing公式（f_code = ∂v/∂t - P∆v - v×rot(v) + ∇p）

### 数值精度
- 散度：O(10⁻¹⁵) ✓✓✓
- 初始误差：O(10⁻¹⁴) ✓✓
- 累积误差：O(10⁻⁶) ⚠

### 计算成本
- 128³，100步：~10秒（4进程）
- 256³，100步：~2分钟（4进程，估计）

---

**诊断人员**：Claude Code
**状态**：代码数学上正确，但数值精度存在意外降低，需要进一步分析时间积分与投影的交互
